version: '{build}'

image:
  - Visual Studio 2019

environment:
  matrix:
    - arch: x64
      platform: x64
      GENERATOR: Visual Studio 16 2019
      BUILD_TYPE: Debug

    - arch: x64
      platform: x64
      GENERATOR: Visual Studio 16 2019
      BUILD_TYPE: Release

init:
  - ps: iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
  - where cmake
  - ps: Invoke-WebRequest -Uri https://cmake.org/files/v3.15/cmake-3.15.2-win64-x64.zip -OutFile cmake.zip
  - 7z x cmake.zip -o"c:\Program Files (x86)\CMake\" -y
  - ps: Get-ChildItem "C:\Program Files (x86)\CMake\"
  - ps: Get-ChildItem "C:\Program Files (x86)\CMake\cmake-3.15.2-win64-x64\"
  - ps: Copy-Item -Path "C:\Program Files (x86)\CMake\cmake-3.15.2-win64-x64\*" -Destination "C:\Program Files (x86)\CMake\" -Force -Recurse
  - ps: Get-ChildItem "C:\Program Files (x86)\CMake\"
  - ps: Get-ChildItem "C:\Program Files (x86)\CMake\cmake-3.15.2-win64-x64\"
  - rm cmake.zip
  - cmake --version

before_build:
  - mkdir build
  - cd build
  - cmake ../ -G "%GENERATOR%" -A %platform% -DCMAKE_BUILD_TYPE=%BUILD_TYPE% -DCMAKE_IGNORE_PATH="C:/Program Files/Git/usr/bin" -T "ClangCl" -DCMAKE_CXX_COMPILER="C:/Program Files/LLVM/bin/clang-cl.exe"

build_script:
  - cmake --build . --config %BUILD_TYPE%
  - cd bin && cd %BUILD_TYPE% && ls
  - ps: |
      $filePattern = '*_tests.exe'
      foreach ($file in get-ChildItem $filePattern)
      {
        $var = $file.name
        & cmd /c "$var --reporters=xml --out=$var-result.xml -s 2>&1"
      }
      ls
on_failure:
  - curl -s https://report.ci/annotate.py | python - --tool msvc --input build.log

on_finish:
  # Framework with autodetection
  - ps: |
      ls
      $string = "$env:GENERATOR-$env:BUILD_TYPE"
      echo $string
      $string = $string -replace ' ', '-'
      echo $string
      Invoke-WebRequest -Uri https://report.ci/upload.py -OutFile upload.py
      python upload.py -n "Doctest [appveyor $($string)]" --include='*.xml' --framework=doctest --merge .*
